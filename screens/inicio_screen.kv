#:kivy 2.0.0
#:import ScrollEffect kivy.effects.scroll.ScrollEffect
#:import dp kivy.metrics.dp

<HabitCard>:
    ripple_behavior: True
    size_hint_y: None
    height: "120dp"
    padding: dp(15)
    radius: dp(12)
    md_bg_color: 0.12, 0.16, 0.23, 1
    elevation: 3
    
    BoxLayout:
        orientation: 'vertical'
        spacing: dp(1)
        
        # Fila superior: Nombre + Botón menú - MODIFICADO
        RelativeLayout:
            size_hint_y: None
            height: dp(30)  # Altura suficiente para título y botón
            
            # Nombre del hábito
            MDLabel:
                text: root.nombre
                font_style: "H6"
                bold: True
                theme_text_color: "Custom"
                text_color: 1, 1, 1, 1
                size_hint_x: 0.7
                size_hint_y: None
                height: dp(30)
                halign: "left"
                valign: "middle"
                text_size: self.width, None
                pos_hint: {'left': 1, 'center_y': 0.5}
            
            # Objetivo
            MDLabel:
                text: f"{root.objetivo}min"
                font_style: "Caption"
                theme_text_color: "Custom"
                text_color: 0.16, 0.73, 0.51, 1
                size_hint: None, None
                size: dp(50), dp(20)
                halign: "right"
                valign: "middle"
                text_size: self.size
                pos_hint: {'right': 0.85, 'center_y': 0.5}
            
            MDIconButton:
                icon: "dots-vertical"
                theme_text_color: "Custom"
                text_color: 0.7, 0.7, 0.7, 1
                size_hint: None, None
                size: dp(40), dp(40) 
                padding: dp(10)
                pos_hint: {'right': 1, 'center_y': 0.5} 
                on_release: root.menu.open()
        
        MDLabel:
            text: root.descripcion
            font_style: "Caption"
            theme_text_color: "Custom"
            text_color: 0.7, 0.7, 0.7, 1
            size_hint_y: None
            height: dp(20) if root.descripcion else 0
            opacity: 1 if root.descripcion else 0
            text_size: self.width, None
            halign: "left"
            valign: "top"
            padding_y: dp(-2)
        
        Widget:
            size_hint_y: None
            height: dp(5) if root.descripcion else dp(10)
        
        GridLayout:
            cols: 3
            spacing: dp(10)
            size_hint_y: None
            height: dp(40)
            
            # Sesiones
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(2)
                
                MDLabel:
                    text: "Sesiones"
                    font_style: "Overline"
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 0.7, 0.7, 0.7, 1
                    size_hint_y: None
                    height: dp(15)
                
                MDLabel:
                    text: str(root.sesiones)
                    font_style: "H6"
                    bold: True
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 0, 0.97, 1, 1
            
            # Racha
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(2)
                
                MDLabel:
                    text: "Racha"
                    font_style: "Overline"
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 0.7, 0.7, 0.7, 1
                    size_hint_y: None
                    height: dp(15)
                
                MDLabel:
                    text: f"{root.racha}d"
                    font_style: "H6"
                    bold: True
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 1, 0.65, 0, 1
            
            # Total
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(2)
                
                MDLabel:
                    text: "Total"
                    font_style: "Overline"
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 0.7, 0.7, 0.7, 1
                    size_hint_y: None
                    height: dp(15)
                
                MDLabel:
                    text: f"{root.total_min}m"
                    font_style: "H6"
                    bold: True
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 0.8, 0.5, 1, 1

<InicioScreen>:
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.05, 0.05, 0.05, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            orientation: 'vertical'
            size_hint: None, None
            size: 300, 100
            pos_hint: {'x': 0.05, 'top': 1.04}
            spacing: 5
            
            MDLabel:
                text: "HabitTracker"
                font_style: "H6"
                bold: True
                halign: "left"
                size_hint_y: None
                height: 40
                theme_text_color: "Custom"
                text_color: 0, 0.9686, 1, 1
            
            MDLabel:
                id: bienvenido
                text: "Hola, Usuario"
                font_size: "14sp"
                halign: "left"
                size_hint_y: None
                height: 15
                theme_text_color: "Custom"
                text_color: 0.8, 0.8, 0.8, 1
        
        # Botón salir
        MDRaisedButton:
            text: "Salir"
            size_hint: None, None
            size: 80, 40
            pos_hint: {'right': 0.95, 'top': 0.97}
            md_bg_color: 0.3, 0.3, 0.3, 1
            text_color: 1, 1, 1, 1
            on_release: root.logout()
        
        # Barra de progreso general
        MDCard:
            orientation: 'vertical'
            size_hint: 0.9, None
            height: dp(70)
            pos_hint: {'center_x': 0.5, 'top': 0.88}
            padding: dp(15)
            spacing: dp(10)
            radius: dp(12)
            md_bg_color: 0.12, 0.16, 0.23, 1
            
            BoxLayout:
                orientation: 'horizontal'
                
                MDLabel:
                    id: progreso_general_texto
                    text: "Progreso General"
                    font_style: "Caption"
                    theme_text_color: "Custom"
                    text_color: 0.7, 0.7, 0.7, 1
                    size_hint_x: 0.7
                
                MDLabel:
                    id: progreso_general_porcentaje
                    text: "0%"
                    font_style: "H6"
                    bold: True
                    halign: "right"
                    theme_text_color: "Custom"
                    text_color: 0, 0.97, 1, 1
                    size_hint_x: 0.3
            
            ProgressBar:
                id: barra_progreso_general
                max: 100
                value: 0
                size_hint_y: None
                height: dp(8)
        
        # Estadísticas (2x2)
        GridLayout:
            cols: 2
            spacing: 15
            size_hint: 0.9, None
            height: dp(200)
            pos_hint: {'center_x': 0.5, 'top': 0.75}
            
            # Card Sesiones
            MDCard:
                size_hint: None, None
                size: self.parent.width/2 - 10, dp(90)
                md_bg_color: 0.12, 0.16, 0.23, 1
                elevation: 2
                radius: dp(10)
                padding: dp(10)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(5)
                    
                    MDLabel:
                        text: "Sesiones"
                        font_size: "12sp"
                        bold: True
                        halign: "center"
                        theme_text_color: "Custom"
                        text_color: 0.7, 0.7, 0.7, 1
                        size_hint_y: None
                        height: dp(20)
                    
                    MDLabel:
                        id: sesiones
                        text: "0"
                        font_style: "H5"
                        bold: True
                        halign: "center"
                        theme_text_color: "Custom"
                        text_color: 0, 0.9686, 1, 1
                        size_hint_y: None
                        height: dp(40)
                        
                    MDLabel:
                        text: "Total"
                        font_size: "10sp"
                        halign: "center"
                        theme_text_color: "Custom"
                        text_color: 0.5, 0.5, 0.5, 1
            
            # Card Tiempo
            MDCard:
                size_hint: None, None
                size: self.parent.width/2 - 10, dp(90)
                md_bg_color: 0.12, 0.16, 0.23, 1
                elevation: 2
                radius: dp(10)
                padding: dp(10)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(5)
                    
                    MDLabel:
                        text: "Tiempo"
                        font_size: "12sp"
                        bold: True
                        halign: "center"
                        theme_text_color: "Custom"
                        text_color: 0.7, 0.7, 0.7, 1
                        size_hint_y: None
                        height: dp(20)
                    
                    MDLabel:
                        id: tiempo
                        text: "0"
                        font_style: "H5"
                        bold: True
                        halign: "center"
                        theme_text_color: "Custom" 
                        text_color: 0.8, 0.5, 1, 1
                        size_hint_y: None
                        height: dp(40)
                        
                    MDLabel:
                        text: "Minutos"
                        font_size: "10sp"
                        halign: "center"
                        theme_text_color: "Custom"
                        text_color: 0.5, 0.5, 0.5, 1
            
            # Card Racha
            MDCard:
                size_hint: None, None
                size: self.parent.width/2 - 10, dp(90)
                md_bg_color: 0.12, 0.16, 0.23, 1
                elevation: 2
                radius: dp(10)
                padding: dp(10)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(5)
                    
                    MDLabel:
                        text: "Racha"
                        font_size: "12sp"
                        bold: True
                        halign: "center"
                        theme_text_color: "Custom"
                        text_color: 0.7, 0.7, 0.7, 1
                        size_hint_y: None
                        height: dp(20)
                    
                    MDLabel:
                        id: racha
                        text: "0"
                        font_style: "H5"
                        bold: True
                        halign: "center"
                        theme_text_color:"Custom"
                        text_color: 1, 0.5, 0, 1
                        size_hint_y: None
                        height: dp(40)
                        
                    MDLabel:
                        text: "Días"
                        font_size: "10sp"
                        halign: "center"
                        theme_text_color: "Custom"
                        text_color: 0.5, 0.5, 0.5, 1
            
            # Card Hoy
            MDCard:
                size_hint: None, None
                size: self.parent.width/2 - 10, dp(90)
                md_bg_color: 0.12, 0.16, 0.23, 1
                elevation: 2
                radius: dp(10)
                padding: dp(10)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(5)
                    
                    MDLabel:
                        text: "Hoy"
                        font_size: "12sp"
                        bold: True
                        halign: "center"
                        theme_text_color:"Custom"
                        text_color: 0.7, 0.7, 0.7, 1
                        size_hint_y: None
                        height: dp(20)
                    
                    MDLabel:
                        id: hoy
                        text: "0"
                        font_style: "H5"
                        bold: True
                        halign: "center"
                        theme_text_color:"Custom"
                        text_color: 0.2, 0.8, 0.2, 1
                        size_hint_y: None
                        height: dp(40)
                        
                    MDLabel:
                        text: "Minutos"
                        font_size: "10sp"
                        halign: "center"
                        theme_text_color: "Custom"
                        text_color: 0.5, 0.5, 0.5, 1
        
        ScrollView:
            size_hint: 0.9, 0.34
            pos_hint: {'center_x': 0.5, 'y': 0.1}
            effect_cls: ScrollEffect
            
            GridLayout:
                id: habits_container
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(15)
                padding: [0, dp(10), 0, dp(20)]
        
        # Botón para agregar hábitos
        MDRaisedButton:
            id: add_button
            text: "+ Nuevo Habito"
            size_hint: 0.9, None
            height: dp(50)
            pos_hint: {'center_x': 0.5, 'y': 0.03}
            md_bg_color: 0.2, 0.5, 0.9, 1
            elevation: 4
            on_release: root.add_new_habit()